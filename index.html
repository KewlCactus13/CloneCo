<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Clone - P2P Servers & Invites</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body { background-color: #313338; color: white; font-family: 'Helvetica Neue', sans-serif; overflow: hidden; }
        .sidebar-dark { background-color: #1e1f22; }
        .channel-list { background-color: #2b2d31; }
        .chat-area { background-color: #313338; }
        .input-box { background-color: #383a40; }
        .discord-gradient { background: linear-gradient(135deg, #5865f2 0%, #4752c4 100%); }
        .server-icon { 
            width: 48px; height: 48px; border-radius: 50%; 
            background-color: #313338; display: flex; 
            align-items: center; justify-content: center; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            cursor: pointer; overflow: hidden;
        }
        .server-icon:hover, .server-active { border-radius: 15px; background-color: #5865f2; color: white; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #1a1b1e; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="app" class="flex h-screen w-full">
        
        <transition name="fade">
            <div v-if="!isLoggedIn" class="fixed inset-0 z-50 flex items-center justify-center bg-[#1e1f22]">
                <div class="bg-[#313338] p-10 rounded-lg shadow-2xl w-[450px] text-center animate__animated animate__zoomIn animate__faster">
                    <h2 class="text-2xl font-bold mb-2">Welcome back!</h2>
                    <p class="text-gray-400 mb-8">Login to start P2P chatting.</p>
                    <div class="text-left mb-6">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Username</label>
                        <input v-model="tempUsername" @keyup.enter="login" type="text" class="w-full p-2.5 rounded bg-[#1e1f22] text-white outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    </div>
                    <button @click="login" class="w-full py-3 rounded discord-gradient font-bold text-white transition transform active:scale-95">Log In</button>
                </div>
            </div>
        </transition>

        <template v-if="isLoggedIn">
            <div class="sidebar-dark w-18 flex flex-col items-center py-3 space-y-2 px-3 border-r border-black/10">
                <div @click="viewDMs" class="server-icon" :class="{'server-active': activeMode === 'dms'}">
                    <svg class="w-7 h-7" :class="activeMode === 'dms' ? 'text-white' : 'text-indigo-500'" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14h2v-2h-2v2zm0-4h2V7h-2v5z"/></svg>
                </div>
                <div class="w-8 border-t border-gray-700 my-1"></div>
                
                <div v-for="server in servers" :key="server.id" @click="setActiveServer(server)" 
                     class="server-icon animate__animated animate__bounceIn" :class="{'server-active': activeChat.id === server.id}">
                    <span class="font-bold text-xs">{{ server.initials }}</span>
                </div>

                <div @click="showServerModal = true" class="server-icon text-green-500 hover:text-white">
                    <span class="text-2xl">+</span>
                </div>
            </div>

            <div class="channel-list w-60 flex flex-col shadow-xl">
                <div class="p-4 h-12 flex items-center border-b border-black/20 font-bold justify-between">
                    <span class="truncate">{{ activeMode === 'dms' ? 'Direct Messages' : activeChat.name }}</span>
                    <button v-if="activeMode === 'servers'" @click="showSvrSettings = true" class="text-gray-400 hover:text-white text-xs">⚙</button>
                </div>
                <div class="flex-1 overflow-y-auto p-2">
                    <template v-if="activeMode === 'dms'">
                        <div v-for="friend in friends" @click="setActiveChat(friend)" :class="{'bg-[#3f4147] text-white': activeChat.id === friend.id}" class="flex items-center p-2 rounded hover:bg-[#35373c] cursor-pointer mb-1 text-gray-400 transition-all group">
                            <img :src="friend.pfp || 'https://api.dicebear.com/7.x/initials/svg?seed='+friend.name" class="w-8 h-8 rounded-full mr-3 aspect-square object-cover">
                            <span class="group-hover:text-gray-200 truncate">{{ friend.name }}</span>
                        </div>
                        <div class="mt-5 px-2 text-xs font-bold text-gray-400 uppercase flex justify-between items-center">
                            Add Friend <button @click="showAddFriendModal = true" class="hover:text-white text-lg">+</button>
                        </div>
                    </template>

                    <template v-else>
                        <div v-for="channel in activeChat.channels" @click="activeChat.activeChannel = channel" 
                             :class="{'bg-[#3f4147] text-white': activeChat.activeChannel === channel}"
                             class="flex items-center p-2 rounded hover:bg-[#35373c] cursor-pointer mb-1 text-gray-400 transition-all">
                            <span class="text-gray-500 mr-2">#</span> {{ channel }}
                        </div>
                        <div class="mt-4 px-2">
                            <button @click="showInviteModal = true" class="w-full py-1.5 bg-indigo-500 text-white rounded text-xs font-bold hover:bg-indigo-600 transition-colors">Invite Friends</button>
                        </div>
                    </template>
                </div>

                <div class="bg-[#232428] p-2 flex items-center justify-between">
                    <div class="flex items-center overflow-hidden">
                        <img :src="user.pfp" class="w-8 h-8 rounded-full flex-shrink-0 object-cover">
                        <div class="ml-2 truncate">
                            <div class="text-xs font-bold truncate">{{ user.name }}</div>
                            <div class="text-[10px] text-green-400 font-bold uppercase">Online</div>
                        </div>
                    </div>
                    <button @click="showSettings = true" class="text-gray-400 hover:text-white p-1 transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                    </button>
                </div>
            </div>

            <div class="flex-1 flex flex-col chat-area">
                <div class="h-12 border-b border-black/20 flex items-center px-4 font-bold shadow-sm">
                    <span class="text-gray-400 mr-2 text-xl">{{ activeMode === 'dms' ? '@' : '#' }}</span> 
                    {{ activeMode === 'dms' ? activeChat.name : activeChat.activeChannel }}
                </div>
                <div class="flex-1 p-4 overflow-y-auto space-y-4" id="chat-window">
                    <div v-for="msg in currentMessages" :key="msg.timestamp" class="flex animate__animated animate__fadeInUp animate__faster">
                        <img :src="msg.pfp" class="w-10 h-10 rounded-full mr-4 object-cover flex-shrink-0">
                        <div>
                            <div class="flex items-center"><span class="font-bold mr-2 text-white">{{ msg.user }}</span><span class="text-xs text-gray-500">{{ msg.time }}</span></div>
                            
                            <div v-if="msg.isInvite" class="bg-[#2b2d31] p-3 rounded-lg border border-indigo-500 mt-2">
                                <p class="text-sm mb-2">You've been invited to join <b>{{ msg.serverName }}</b></p>
                                <button @click="joinServer(msg.serverData)" class="bg-green-600 hover:bg-green-700 px-4 py-1 rounded text-xs font-bold transition-colors">Join Server</button>
                            </div>
                            
                            <div v-else class="text-gray-300 mt-0.5">{{ msg.text }}</div>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <div class="input-box flex items-center px-4 py-2.5 rounded-lg">
                        <input v-model="newMessage" @keyup.enter="sendMessage" type="text" :placeholder="'Message ' + (activeMode === 'dms' ? activeChat.name : '#' + activeChat.activeChannel)" class="w-full bg-transparent outline-none text-gray-200">
                    </div>
                </div>
            </div>
        </template>

        <transition name="fade">
            <div v-if="showSettings" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#1e1f22]">
                <div class="flex w-full h-full max-w-5xl bg-[#313338] animate__animated animate__fadeIn">
                    <div class="w-64 bg-[#2b2d31] p-10 flex flex-col text-right">
                        <div class="text-xs font-bold text-gray-400 uppercase mb-2">User Settings</div>
                        <div class="bg-[#3f4147] text-white p-2 rounded mb-1 text-sm font-medium text-left pl-4">My Account</div>
                        <div class="text-gray-400 p-2 rounded text-sm hover:bg-[#35373c] cursor-pointer text-left pl-4 mt-auto text-red-400 font-bold" @click="location.reload()">Log Out</div>
                    </div>
                    <div class="flex-1 p-16 relative overflow-y-auto">
                        <button @click="showSettings = false" class="absolute right-10 top-10 text-gray-400 hover:text-white border-2 border-gray-400 rounded-full p-1 transition-all">✕</button>
                        <h2 class="text-xl font-bold mb-8">My Account</h2>
                        <div class="bg-[#1e1f22] rounded-lg p-6">
                            <div class="flex items-center mb-6">
                                <div class="relative group cursor-pointer" @click="$refs.fileInput.click()">
                                    <img :src="user.pfp" class="w-20 h-20 rounded-full border-4 border-[#313338] object-cover mr-4 group-hover:opacity-50 transition-opacity">
                                    <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 text-[10px] font-bold uppercase text-center pr-4">Change</div>
                                    <input type="file" ref="fileInput" class="hidden" accept="image/*" @change="handleFileUpload">
                                </div>
                                <div><div class="text-lg font-bold">{{ user.name }}</div></div>
                            </div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Display Name</label>
                            <input v-model="user.name" @change="broadcastProfile" class="w-full bg-[#2b2d31] p-2 rounded outline-none border border-black/20 focus:border-indigo-500">
                            <button @click="copyMyId" class="mt-4 text-xs bg-indigo-500 px-4 py-2 rounded font-bold hover:bg-indigo-600">Copy Peer ID</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showServerModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                <div class="bg-[#313338] p-8 rounded-lg w-96 animate__animated animate__zoomIn animate__faster">
                    <h2 class="text-2xl font-bold mb-2 text-center">Create a Server</h2>
                    <input v-model="newServerName" placeholder="Server Name" class="w-full p-3 mb-4 bg-[#1e1f22] rounded text-white outline-none border border-black/10 focus:border-indigo-500 transition-all">
                    <button @click="createServer" class="w-full py-3 discord-gradient rounded font-bold transition transform active:scale-95">Create</button>
                    <button @click="showServerModal = false" class="mt-2 w-full text-gray-400 text-sm py-2">Cancel</button>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showInviteModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                <div class="bg-[#313338] p-6 rounded-lg w-80">
                    <h2 class="text-lg font-bold mb-4">Invite to {{ activeChat.name }}</h2>
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        <div v-for="friend in friends" :key="friend.id" class="flex items-center justify-between p-2 hover:bg-white/5 rounded">
                            <span class="text-sm truncate">{{ friend.name }}</span>
                            <button @click="sendInvite(friend)" class="text-xs bg-indigo-500 px-3 py-1 rounded">Invite</button>
                        </div>
                    </div>
                    <button @click="showInviteModal = false" class="mt-4 w-full text-gray-400 text-sm">Close</button>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showSvrSettings" class="fixed inset-0 bg-black/70 flex items-center justify-center z-[110]">
                <div class="bg-[#313338] p-8 rounded-lg w-96">
                    <h2 class="text-xl font-bold mb-4">Server Channels</h2>
                    <input v-model="newChannelName" placeholder="New channel name..." class="w-full p-2 mb-4 bg-[#1e1f22] rounded outline-none border border-black/10">
                    <button @click="addChannel" class="w-full py-2 bg-indigo-500 rounded font-bold">Add Channel</button>
                    <button @click="showSvrSettings = false" class="mt-4 w-full text-gray-400 text-sm">Close</button>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showAddFriendModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                <div class="bg-[#313338] p-8 rounded-lg w-96 animate__animated animate__zoomIn animate__faster">
                    <h2 class="text-2xl font-bold mb-2 text-center">Add Friend</h2>
                    <input v-model="friendIdToConnect" placeholder="Paste Peer ID here..." class="w-full p-3 mb-4 bg-[#1e1f22] rounded text-white outline-none border border-black/10 focus:border-indigo-500">
                    <button @click="connectToFriend" class="w-full py-3 discord-gradient rounded font-bold transition transform active:scale-95">Connect</button>
                    <button @click="showAddFriendModal = false" class="mt-2 w-full text-gray-400 text-sm py-2">Cancel</button>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, nextTick } = Vue;
        createApp({
            setup() {
                const isLoggedIn = ref(false), tempUsername = ref('');
                const user = ref({ name: 'User', pfp: `https://api.dicebear.com/7.x/avataaars/svg?seed=${Math.random()}` });
                const peer = ref(null), myPeerId = ref('Connecting...'), connections = ref({});
                const friends = ref([{ id: 'bot-pringle', name: 'Pringle', pfp: 'https://api.dicebear.com/7.x/bottts/svg?seed=Pringle' }]);
                
                const activeMode = ref('dms'), servers = ref([]), chatHistory = ref({ 'bot-pringle': [] });
                const activeChat = ref(friends.value[0]);
                
                const newMessage = ref(''), friendIdToConnect = ref(''), newServerName = ref(''), newChannelName = ref('');
                const showSettings = ref(false), showAddFriendModal = ref(false), showServerModal = ref(false), showInviteModal = ref(false), showSvrSettings = ref(false);

                // Computed: Get messages based on active DM or Server+Channel
                const currentMessages = computed(() => {
                    const chatId = activeMode.value === 'dms' 
                        ? activeChat.value.id 
                        : `${activeChat.value.id}-${activeChat.value.activeChannel}`;
                    return chatHistory.value[chatId] || [];
                });

                const initPeer = () => {
                    peer.value = new Peer();
                    peer.value.on('open', (id) => myPeerId.value = id);
                    peer.value.on('connection', (conn) => setupConnHandlers(conn));
                };

                const setupConnHandlers = (conn) => {
                    conn.on('open', () => {
                        connections.value[conn.peer] = conn;
                        broadcastProfile();
                        if (!friends.value.find(f => f.id === conn.peer)) {
                            friends.value.push({ id: conn.peer, name: 'Connecting...', pfp: '' });
                        }
                    });

                    conn.on('data', (data) => {
                        if (data.type === 'handshake') {
                            const f = friends.value.find(f => f.id === conn.peer);
                            if (f) { f.name = data.name; f.pfp = data.pfp; }
                        } else if (data.type === 'server-msg') {
                            const chanKey = `${data.serverId}-${data.channel}`;
                            if (!chatHistory.value[chanKey]) chatHistory.value[chanKey] = [];
                            chatHistory.value[chanKey].push(data);
                            scrollToBottom();
                        } else {
                            // Standard DM or Invite
                            const source = conn.peer;
                            if (!chatHistory.value[source]) chatHistory.value[source] = [];
                            chatHistory.value[source].push(data);
                            scrollToBottom();
                        }
                    });
                };

                const handleFileUpload = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        user.value.pfp = e.target.result;
                        broadcastProfile();
                    };
                    reader.readAsDataURL(file);
                };

                const broadcastProfile = () => {
                    Object.values(connections.value).forEach(conn => {
                        conn.send({ type: 'handshake', name: user.value.name, pfp: user.value.pfp });
                    });
                };

                const createServer = () => {
                    if (!newServerName.value.trim()) return;
                    const id = 'srv-' + Math.random().toString(36).substr(2, 9);
                    const srv = { 
                        id, 
                        name: newServerName.value, 
                        initials: newServerName.value.substring(0,2).toUpperCase(),
                        channels: ['general'],
                        activeChannel: 'general'
                    };
                    servers.value.push(srv);
                    showServerModal.value = false;
                    newServerName.value = '';
                    setActiveServer(srv);
                };

                const addChannel = () => {
                    if (!newChannelName.value.trim()) return;
                    const cleanName = newChannelName.value.toLowerCase().replace(/\s+/g, '-');
                    activeChat.value.channels.push(cleanName);
                    newChannelName.value = '';
                    showSvrSettings.value = false;
                };

                const sendInvite = (friend) => {
                    const conn = connections.value[friend.id];
                    if (conn) {
                        const inviteData = {
                            user: user.value.name,
                            pfp: user.value.pfp,
                            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                            timestamp: Date.now(),
                            isInvite: true,
                            serverName: activeChat.value.name,
                            serverData: JSON.parse(JSON.stringify(activeChat.value)) // Snapshot of server
                        };
                        conn.send(inviteData);
                        showInviteModal.value = false;
                    }
                };

                const joinServer = (serverData) => {
                    if (!servers.value.find(s => s.id === serverData.id)) {
                        servers.value.push(serverData);
                    }
                    setActiveServer(serverData);
                };

                const login = () => { if (tempUsername.value.trim()) { user.value.name = tempUsername.value; isLoggedIn.value = true; initPeer(); } };
                
                const sendMessage = () => {
                    if (!newMessage.value.trim()) return;
                    const msg = { 
                        user: user.value.name, 
                        text: newMessage.value, 
                        pfp: user.value.pfp, 
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 
                        timestamp: Date.now() 
                    };

                    if (activeMode.value === 'servers') {
                        msg.type = 'server-msg';
                        msg.serverId = activeChat.value.id;
                        msg.channel = activeChat.value.activeChannel;
                        // Broadcast to all connected peers
                        Object.values(connections.value).forEach(c => c.send(msg));
                        
                        const chanKey = `${msg.serverId}-${msg.channel}`;
                        if (!chatHistory.value[chanKey]) chatHistory.value[chanKey] = [];
                        chatHistory.value[chanKey].push(msg);
                    } else {
                        if (connections.value[activeChat.value.id]) connections.value[activeChat.value.id].send(msg);
                        if (!chatHistory.value[activeChat.value.id]) chatHistory.value[activeChat.value.id] = [];
                        chatHistory.value[activeChat.value.id].push(msg);
                    }
                    newMessage.value = ''; 
                    scrollToBottom();
                };

                const connectToFriend = () => {
                    if (!friendIdToConnect.value || friendIdToConnect.value === myPeerId.value) return;
                    setupConnHandlers(peer.value.connect(friendIdToConnect.value));
                    showAddFriendModal.value = false; friendIdToConnect.value = '';
                };

                const scrollToBottom = () => nextTick(() => { const el = document.getElementById('chat-window'); if(el) el.scrollTop = el.scrollHeight; });
                const copyMyId = () => { navigator.clipboard.writeText(myPeerId.value); alert("ID Copied!"); };
                const viewDMs = () => { activeMode.value = 'dms'; activeChat.value = friends.value[0]; };
                const setActiveChat = (c) => { activeChat.value = c; };
                const setActiveServer = (s) => { activeMode.value = 'servers'; activeChat.value = s; };

                return { 
                    isLoggedIn, tempUsername, user, myPeerId, friends, activeChat, chatHistory, newMessage, 
                    showSettings, showAddFriendModal, friendIdToConnect, activeMode, servers, 
                    showServerModal, newServerName, showInviteModal, showSvrSettings, newChannelName,
                    currentMessages,
                    login, sendMessage, copyMyId, viewDMs, setActiveChat, connectToFriend, 
                    handleFileUpload, broadcastProfile, createServer, setActiveServer, sendInvite, joinServer, addChannel
                };
            }
        }).mount('#app');
    </script>
</body>
</html>